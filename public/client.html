<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .main {
            display: flex;
            flex-direction: row;
        }

        #messages {
            display: flex;
            flex-direction: column;
            position: relative;
            width: 250px;
            height: 500px;
            background-color: #F9FAFC;
            border: 1px solid grey;
            overflow-y: scroll;
        }

        #messages .message {
            margin: 5px;
            padding: 5px;
        }

        .sended {
            background-color: #7388DF;
            color: white;
            align-self: flex-end;
            border-radius: 30px 0 30px 30px;
        }

        .recived {
            background-color: #ffffff;
            align-self: flex-start;
            border-radius: 0 30px 30px 30px;
        }

        .system-message {
            color: #777777;
            align-self: center;
        }
    </style>
</head>

<body>
    <div class="main">
        <div id="player"></div>
        <div class="chat">
            <div id="messages"></div>
            <input type="text" id="message">
            <button id="sendButton" onclick="sendMessage()">Send</button>
        </div>
    </div>


    <button onclick="share()">Copy invite Link</button>

    <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.4.0/dist/socket.io.min.js"></script>
    <script>
        let messageInput = document.getElementById('message');
        let messages = document.getElementById('messages');
        messageInput.focus();
        let params = new URLSearchParams(document.location.search),
            [username, roomId, fullVideoUrl, create] = [params.get('username'), params.get('roomId'), params.get('video'), params.get('create')],
            videoId = fullVideoUrl.replace('https://www.youtube.com/watch?v=', '');

        var socket = io('http://localhost:3000', { transports: ['websocket', 'polling', 'flashsocket'] });
        if (create) {
            socket.emit('create-room', { username, video: videoId });
        } else {
            socket.emit('join-room', { username, roomId });
        }

        messageInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                return sendMessage();
            }
        });

        const addMessage = (data, isRecived = false) => {
            let message = document.createElement('span');
            message.innerHTML = `${isRecived ? (!data.isSystemMessage ? '<small><strong>' + data.username + '</strong></small><br/>' : '') : ''}${data.text}`;
            message.className = `message ${isRecived ? (data.isSystemMessage ? 'system-message' : 'recived') : 'sended'}`;
            messages.appendChild(message);
        };

        const addMessages = (messages) => {
            messages.forEach(message => {
                addMessage(message, true);
            });
        }

        function sendMessage() {
            addMessage({ text: messageInput.value, username: '', date: new Date() });
            socket.emit('message', {
                message: messageInput.value,
                user: username,
                roomId,
            });
            messageInput.value = '';
            messageInput.focus();
        }
        socket.on('connect', e => {
            if (!create) {
                // oda oluşturulmadan önce room*info kullanılamaz
                socket.emit('room-info', roomId);
            }

        });
        socket.on('message', (e) => {
            addMessage(JSON.parse(e), true);
        });
        socket.on('room-info', (room) => {
            roomId = room.id
            addMessages(room.messages);
        })
        socket.on('disconnect', (e) => {
            messageInput.disabled = true;
            document.getElementById('sendButton').disabled = true;
        });

        // 2. This code loads the IFrame Player API code asynchronously.
        var tag = document.createElement('script');

        tag.src = "https://www.youtube.com/iframe_api";
        var firstScriptTag = document.getElementsByTagName('script')[1];
        firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

        // 3. This function creates an <iframe> (and YouTube player)
        //    after the API code downloads.
        var player;
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                height: '390',
                width: '640',
                videoId,
                playerVars: {
                    'playsinline': 1
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange
                }
            });
        }

        // 4. The API will call this function when the video player is ready.
        function onPlayerReady(event) {
            event.target.playVideo();
        }

        let isPlayerStateChangedByOtherUser = false
        // 5. The API calls this function when the player's state changes.
        //    The function indicates that when playing a video (state=1),
        function onPlayerStateChange(event) {
            if (event.data == YT.PlayerState.PAUSED && !isPlayerStateChangedByOtherUser) {
                socket.emit('durdu', { roomId, username });
            }
            if (event.data == YT.PlayerState.PLAYING && !isPlayerStateChangedByOtherUser) {
                socket.emit('oynat', { roomId, username });
            }
            isPlayerStateChangedByOtherUser = false;
        }

        socket.on('video-durdur', () => {
            isPlayerStateChangedByOtherUser = true;
            player.stopVideo();
        })
        socket.on('video-oynat', () => {
            isPlayerStateChangedByOtherUser = true;
            player.playVideo();
        })

        function share() {
            navigator.clipboard.writeText(`${document.location.origin}/join-room/${roomId}`);
            alert('link copied');
        }
    </script>
</body>

</html>